#!/bin/bash
# Instalador completo MOD-V6 sin validaciÃ³n

echo -e "\033[1;36m"
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  INSTALACIÃ“N COMPLETA MOD-V6             â•‘"
echo "â•‘   (Sin validaciÃ³n de key)                â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "\033[0m"

# Descargar scripts de instalaciÃ³n originales (pero modificados)
cd /tmp

# Descargar instaladores individuales
echo -e "\033[1;32m[1/8] Descargando instaladores...\033[0m"

scripts=(
    "https://raw.githubusercontent.com/ChumoGH/ChumoGH-Script/master/ssh.sh"
    "https://raw.githubusercontent.com/ChumoGH/ChumoGH-Script/master/squid.sh"
    "https://raw.githubusercontent.com/ChumoGH/ChumoGH-Script/master/badvpn.sh"
    "https://raw.githubusercontent.com/ChumoGH/ChumoGH-Script/master/stunnel.sh"
    "https://raw.githubusercontent.com/ChumoGH/ChumoGH-Script/master/dropbear.sh"
    "https://raw.githubusercontent.com/ChumoGH/ChumoGH-Script/master/openvpn.sh"
)

for script in "${scripts[@]}"; do
    nombre=$(basename "$script")
    echo -ne "  â†’ $nombre "
    wget -q "$script" -O "/tmp/$nombre"
    [ $? -eq 0 ] && echo -e "\033[1;32mâœ“\033[0m" || echo -e "\033[1;31mâœ—\033[0m"
done

# Modificar scripts para quitar validaciones
echo -e "\033[1;32m[2/8] Modificando scripts...\033[0m"
for script in /tmp/*.sh; do
    # Quitar lÃ­neas que pidan key o verifiquen licencia
    sed -i '/key\|KEY\|license\|LICENSE\|chave\|validar/d' "$script"
    sed -i '/chekKEY\|checkKEY/d' "$script"
done

# Instalar servicios
echo -e "\033[1;32m[3/8] Instalando servicios...\033[0m"

instalar_servicio() {
    echo -ne "  â†’ $1 "
    bash "/tmp/$2" > /tmp/install.log 2>&1
    [ $? -eq 0 ] && echo -e "\033[1;32mâœ“\033[0m" || echo -e "\033[1;31mâœ—\033[0m"
}

instalar_servicio "OpenSSH" "ssh.sh"
instalar_servicio "Squid Proxy" "squid.sh"
instalar_servicio "BadVPN" "badvpn.sh"
instalar_servicio "Stunnel4" "stunnel.sh"
instalar_servicio "Dropbear" "dropbear.sh"
instalar_servicio "OpenVPN" "openvpn.sh"

# Instalar utilidades del menÃº
echo -e "\033[1;32m[4/8] Instalando utilidades...\033[0m"
cd /etc/adm-lite

# Descargar scripts adicionales
utilidades=(
    "https://raw.githubusercontent.com/ChumoGH/ChumoGH-Script/master/back/autoboot"
    "https://raw.githubusercontent.com/ChumoGH/ChumoGH-Script/master/back/http-server.sh"
    "https://raw.githubusercontent.com/ChumoGH/ChumoGH-Script/master/back/slowdns.sh"
)

for util in "${utilidades[@]}"; do
    nombre=$(basename "$util")
    wget -q "$util" -O "$nombre"
    chmod +x "$nombre" 2>/dev/null
done

# Configurar puertos
echo -e "\033[1;32m[5/8] Configurando puertos...\033[0m"
puertos="22 80 443 8080 3128 7300 7100 7200"
for port in $puertos; do
    ufw allow "$port" > /dev/null 2>&1
done

# Crear usuario administrador
echo -e "\033[1;32m[6/8] Creando usuario admin...\033[0m"
useradd -m -s /bin/bash admin 2>/dev/null
echo "admin:admin123" | chpasswd
usermod -aG sudo admin

# Configurar autoinicio
echo -e "\033[1;32m[7/8] Configurando autoinicio...\033[0m"
echo "@reboot root cd /etc/adm-lite && ./menu > /dev/null 2>&1" >> /etc/crontab

# Crear clave personal final
echo -e "\033[1;32m[8/8] Finalizando instalaciÃ³n...\033[0m"
echo "LICENCIA-COMPLETA-$(hostname)-$(date +%Y%m%d)" > /etc/cghkey
chmod 600 /etc/cghkey

# Limpiar
rm -f /tmp/*.sh /tmp/*.log

echo ""
echo -e "\033[1;36m"
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘    INSTALACIÃ“N COMPLETA FINALIZADA       â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "\033[0m"

echo -e "\033[1;32mâœ… MOD-V6 instalado completamente\033[0m"
echo ""
echo -e "\033[1;37mğŸŒ SERVICIOS ACTIVOS:\033[0m"
echo -e "   \033[1;33mâ€¢ SSH (22, 443) â€¢ Squid (3128, 8080)"
echo -e "   â€¢ Dropbear (443, 80) â€¢ Stunnel (SSL)"
echo -e "   â€¢ BadVPN (7300, 7100, 7200) â€¢ OpenVPN\033[0m"
echo ""
echo -e "\033[1;37mğŸ‘¤ ACCESO:\033[0m"
echo -e "   \033[1;36mUsuario: admin | ContraseÃ±a: admin123\033[0m"
echo ""
echo -e "\033[1;37mğŸ“Š ESTADO:\033[0m"
echo -e "   \033[1;32mâ€¢ Key: $(cat /etc/cghkey)"
echo -e "   â€¢ IP: $(curl -s ifconfig.me)"
echo -e "   â€¢ Servicios: $(systemctl is-active ssh) $(systemctl is-active dropbear)\033[0m"
echo ""
echo -e "\033[1;37mğŸš€ Comando: \033[1;36madm\033[0m"