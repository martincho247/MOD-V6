#!/bin/bash

clear
echo -e "\033[1;36m"
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘        INSTALACIÃ“N MOD-V6 COMPLETA       â•‘"
echo "â•‘          (Todo en un solo script)        â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "\033[0m"

# ====================================================
# VERIFICAR ROOT
# ====================================================
if [ "$EUID" -ne 0 ]; then 
    echo -e "\033[1;31mâœ— Ejecuta como: sudo bash $0\033[0m"
    exit 1
fi

# ====================================================
# 1. INSTALAR DEPENDENCIAS BÃSICAS
# ====================================================
echo -e "\033[1;32m[1/6] Instalando dependencias bÃ¡sicas...\033[0m"
apt-get update -y > /dev/null 2>&1

# Lista completa de paquetes necesarios
PAQUETES=(
    "curl" "wget" "sudo" "nano" "net-tools" "lsof" "screen" "python3" 
    "python3-pip" "git" "unzip" "bc" "ufw" "iptables" "openssh-server"
    "dropbear" "dropbear-initramfs" "squid" "stunnel4" "fail2ban"
    "openvpn" "easy-rsa" "apache2" "php" "libssh2-1-dev" "build-essential"
)

for pkg in "${PAQUETES[@]}"; do
    if ! dpkg -s "$pkg" &> /dev/null; then
        echo -ne "  â†’ $pkg "
        apt-get install -y "$pkg" > /dev/null 2>&1
        if [ $? -eq 0 ]; then
            echo -e "\033[1;32mâœ“\033[0m"
        else
            # Intentar sin el paquete problemÃ¡tico
            echo -e "\033[1;33mâš \033[0m"
        fi
    fi
done

# ====================================================
# 2. CREAR ESTRUCTURA Y DESCARGAR MENÃš
# ====================================================
echo -e "\033[1;32m[2/6] Configurando menÃº principal...\033[0m"
mkdir -p /etc/adm-lite
cd /etc/adm-lite

# Crear archivos del menÃº manualmente si no se pueden descargar
cat > menu << 'EOF'
#!/bin/bash
# MenÃº MOD-V6 modificado para uso personal

# Colores
red='\033[1;31m'
green='\033[1;32m'
yellow='\033[1;33m'
blue='\033[1;34m'
purple='\033[1;35m'
cyan='\033[1;36m'
white='\033[1;37m'
nc='\033[0m'

# FunciÃ³n para mostrar banner
banner() {
    clear
    echo -e "${cyan}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘             MENÃš MOD-V6                  â•‘"
    echo "â•‘         (Modo uso personal)              â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${nc}"
    echo -e "${yellow}â€¢ Usuario: $(whoami)"
    echo -e "â€¢ Hostname: $(hostname)"
    echo -e "â€¢ IP: $(curl -s ifconfig.me 2>/dev/null || echo 'No disponible')"
    echo -e "â€¢ Fecha: $(date)${nc}"
    echo -e "${green}âœ“ ValidaciÃ³n de key desactivada${nc}"
    echo ""
}

# FunciÃ³n para mostrar barra
barra() {
    echo "========================================"
}

# MenÃº principal
while true; do
    banner
    echo -e "${blue}[1]${nc} ${white}GestiÃ³n de usuarios SSH${nc}"
    echo -e "${blue}[2]${nc} ${white}Herramientas del sistema${nc}"
    echo -e "${blue}[3]${nc} ${white}Servicios instalados${nc}"
    echo -e "${blue}[4]${nc} ${white}Estado del servidor${nc}"
    echo -e "${blue}[5]${nc} ${white}Configurar puertos${nc}"
    echo -e "${blue}[6]${nc} ${white}Crear nuevo usuario${nc}"
    echo -e "${blue}[7]${nc} ${white}Reiniciar servicios${nc}"
    echo -e "${blue}[8]${nc} ${white}Instalar mÃ¡s servicios${nc}"
    echo -e "${blue}[9]${nc} ${white}Monitoreo en tiempo real${nc}"
    echo -e "${blue}[0]${nc} ${red}Salir${nc}"
    barra
    
    read -p "Selecciona una opciÃ³n: " opcion
    
    case $opcion in
        1)
            echo -e "${green}Mostrando usuarios SSH...${nc}"
            echo "Usuarios con shell bash:"
            cat /etc/passwd | grep -E "/bin/bash|/bin/sh" | cut -d: -f1
            read -p "Enter para continuar..."
            ;;
        2)
            echo -e "${green}Herramientas del sistema:${nc}"
            echo "1. Ver logs"
            echo "2. Espacio en disco"
            echo "3. Uso de memoria"
            echo "4. Procesos activos"
            read -p "Selecciona: " subop
            case $subop in
                1) tail -20 /var/log/auth.log;;
                2) df -h;;
                3) free -h;;
                4) top -b -n 1 | head -20;;
            esac
            read -p "Enter para continuar..."
            ;;
        3)
            echo -e "${green}Servicios instalados:${nc}"
            echo "âœ“ OpenSSH (puerto 22)"
            echo "âœ“ Dropbear (puertos 443, 80)"
            echo "âœ“ Squid Proxy (puerto 3128)"
            echo "âœ“ Stunnel4 (SSL)"
            echo "âœ“ Apache2 (puerto 81)"
            echo "âœ“ Fail2Ban (protecciÃ³n)"
            read -p "Enter para continuar..."
            ;;
        4)
            echo -e "${green}Estado del servidor:${nc}"
            echo "CPU: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}')%"
            echo "RAM: $(free -h | awk '/^Mem:/ {print $3 "/" $2}')"
            echo "Disco: $(df -h / | awk 'NR==2 {print $4 " libre de " $2}')"
            echo "Uptime: $(uptime -p)"
            read -p "Enter para continuar..."
            ;;
        5)
            echo -e "${green}Configurar puertos:${nc}"
            echo "Puertos actualmente abiertos:"
            ss -tulpn | grep LISTEN | head -10
            read -p "Enter para continuar..."
            ;;
        6)
            echo -e "${green}Crear nuevo usuario:${nc}"
            read -p "Nombre de usuario: " newuser
            read -p "ContraseÃ±a: " -s newpass
            echo
            useradd -m -s /bin/bash "$newuser"
            echo "$newuser:$newpass" | chpasswd
            echo -e "${green}âœ“ Usuario $newuser creado${nc}"
            read -p "Enter para continuar..."
            ;;
        7)
            echo -e "${green}Reiniciando servicios...${nc}"
            systemctl restart ssh
            systemctl restart dropbear
            systemctl restart squid
            systemctl restart stunnel4
            echo -e "${green}âœ“ Servicios reiniciados${nc}"
            sleep 2
            ;;
        8)
            echo -e "${green}Instalar servicios adicionales:${nc}"
            echo "1. BadVPN"
            echo "2. V2Ray"
            echo "3. WireGuard"
            echo "4. Shadowsocks"
            read -p "Selecciona (0 para cancelar): " servicio
            case $servicio in
                1) echo "Instalando BadVPN...";;
                2) echo "Instalando V2Ray...";;
                3) echo "Instalando WireGuard...";;
                4) echo "Instalando Shadowsocks...";;
            esac
            read -p "Enter para continuar..."
            ;;
        9)
            echo -e "${green}Monitoreo en tiempo real (Ctrl+C para salir)${nc}"
            watch -n 2 'echo "CPU: $(top -bn1 | grep "Cpu(s)" | awk "{print \$2}")% | RAM: $(free -h | awk "/^Mem:/ {print \$3}") | Conexiones: $(netstat -an | grep ESTABLISHED | wc -l)"'
            ;;
        0)
            echo -e "${red}Saliendo...${nc}"
            exit 0
            ;;
        *)
            echo -e "${red}OpciÃ³n no vÃ¡lida${nc}"
            sleep 1
            ;;
    esac
done
EOF

# Crear archivo usercodes
cat > usercodes << 'EOF'
#!/bin/bash
echo "GestiÃ³n de usuarios MOD-V6"
echo "=========================="
echo "1. Listar usuarios"
echo "2. Crear usuario"
echo "3. Cambiar contraseÃ±a"
echo "4. Eliminar usuario"
echo "5. Ver usuarios conectados"
read -p "OpciÃ³n: " op
case $op in
    1) cat /etc/passwd | cut -d: -f1;;
    2) read -p "Usuario: " u; read -p "ContraseÃ±a: " -s p; useradd -m $u; echo "$u:$p" | chpasswd;;
    3) read -p "Usuario: " u; passwd $u;;
    4) read -p "Usuario: " u; userdel -r $u;;
    5) who;;
esac
EOF

# Crear archivo ferramentas
cat > ferramentas << 'EOF'
#!/bin/bash
echo "Herramientas MOD-V6"
echo "==================="
echo "1. Test velocidad"
echo "2. Limpiar cache"
echo "3. Optimizar memoria"
echo "4. Backup usuarios"
echo "5. Restaurar backup"
read -p "OpciÃ³n: " op
case $op in
    1) speedtest-cli;;
    2) sync && echo 3 > /proc/sys/vm/drop_caches;;
    3) swapoff -a && swapon -a;;
    4) tar czf /backup_users.tar.gz /home;;
    5) echo "FunciÃ³n de restore";;
esac
EOF

# Dar permisos
chmod +x menu usercodes ferramentas

# ====================================================
# 3. CONFIGURAR SERVICIOS
# ====================================================
echo -e "\033[1;32m[3/6] Configurando servicios...\033[0m"

# Configurar SSH
echo -ne "  â†’ OpenSSH "
sed -i 's/#Port 22/Port 22/g' /etc/ssh/sshd_config
sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/g' /etc/ssh/sshd_config
sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/g' /etc/ssh/sshd_config
systemctl restart ssh
echo -e "\033[1;32mâœ“\033[0m"

# Configurar Dropbear
echo -ne "  â†’ Dropbear "
echo 'NO_START=0
DROPBEAR_PORT=443
DROPBEAR_EXTRA_ARGS="-p 80 -p 445"
DROPBEAR_BANNER="/etc/dropbear/banner"' > /etc/default/dropbear
systemctl restart dropbear
echo -e "\033[1;32mâœ“\033[0m"

# Configurar Squid
echo -ne "  â†’ Squid Proxy "
cat > /etc/squid/squid.conf << 'SQUID'
http_port 3128
http_port 8080
visible_hostname squid-proxy
cache_dir ufs /var/spool/squid 100 16 256
acl localnet src 0.0.0.0/0
http_access allow localnet
http_access deny all
SQUID
systemctl restart squid
echo -e "\033[1;32mâœ“\033[0m"

# Configurar Stunnel
echo -ne "  â†’ Stunnel4 "
openssl req -new -newkey rsa:2048 -days 365 -nodes -x509 -subj "/C=US/ST=State/L=City/O=Organization/CN=localhost" -keyout /etc/stunnel/stunnel.pem -out /etc/stunnel/stunnel.pem
cat > /etc/stunnel/stunnel.conf << 'STUNNEL'
cert = /etc/stunnel/stunnel.pem
socket = l:TCP_NODELAY=1
socket = r:TCP_NODELAY=1
client = no

[ssh]
accept = 444
connect = 127.0.0.1:22

[dropbear]
accept = 445
connect = 127.0.0.1:443
STUNNEL
systemctl restart stunnel4
echo -e "\033[1;32mâœ“\033[0m"

# Configurar Apache para panel web
echo -ne "  â†’ Panel web (Apache) "
echo "<h1>Panel MOD-V6</h1><p>Servidor: $(hostname)</p><p>IP: $(curl -s ifconfig.me 2>/dev/null)</p>" > /var/www/html/index.html
systemctl restart apache2
echo -e "\033[1;32mâœ“\033[0m"

# ====================================================
# 4. CONFIGURAR SISTEMA SIN KEY
# ====================================================
echo -e "\033[1;32m[4/6] Configurando sistema sin validaciÃ³n...\033[0m"

# Crear clave personal
echo "LICENCIA-PERSONAL-$(hostname)-$(date +%Y%m%d-%H%M%S)" > /etc/cghkey
chmod 600 /etc/cghkey

# Configurar firewall
echo -ne "  â†’ Firewall (UFW) "
ufw --force enable > /dev/null 2>&1
ufw allow 22/tcp > /dev/null 2>&1
ufw allow 80/tcp > /dev/null 2>&1
ufw allow 443/tcp > /dev/null 2>&1
ufw allow 3128/tcp > /dev/null 2>&1
ufw allow 8080/tcp > /dev/null 2>&1
ufw allow 444/tcp > /dev/null 2>&1
ufw allow 445/tcp > /dev/null 2>&1
echo -e "\033[1;32mâœ“\033[0m"

# Crear usuario administrador
echo -ne "  â†’ Usuario admin "
useradd -m -s /bin/bash admin 2>/dev/null || true
echo "admin:admin123" | chpasswd
usermod -aG sudo admin 2>/dev/null
echo -e "\033[1;32mâœ“\033[0m"

# ====================================================
# 5. CREAR ACCESOS DIRECTOS Y AUTOINICIO
# ====================================================
echo -e "\033[1;32m[5/6] Creando accesos directos...\033[0m"

# Acceso directo al menÃº
echo '#!/bin/bash
cd /etc/adm-lite
./menu' > /usr/local/bin/adm
chmod +x /usr/local/bin/adm

# Acceso directo a herramientas
echo '#!/bin/bash
cd /etc/adm-lite
./ferramentas' > /usr/local/bin/adm-tools
chmod +x /usr/local/bin/adm-tools

# Configurar autoinicio
echo "@reboot root sleep 30 && cd /etc/adm-lite && ./menu > /dev/null 2>&1" >> /etc/crontab
echo -e "  â†’ Accesos creados \033[1;32mâœ“\033[0m"

# ====================================================
# 6. INSTALACIÃ“N COMPLETADA
# ====================================================
echo -e "\033[1;32m[6/6] Finalizando instalaciÃ³n...\033[0m"
sleep 2

clear
echo -e "\033[1;36m"
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘    âœ… INSTALACIÃ“N COMPLETADA âœ…          â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "\033[0m"

echo -e "\033[1;32mğŸ‰ MOD-V6 instalado exitosamente\033[0m"
echo ""
echo -e "\033[1;37mğŸ“‹ RESUMEN DE LA INSTALACIÃ“N:\033[0m"
echo -e "   \033[1;36mâ€¢ MenÃº principal creado en /etc/adm-lite/"
echo -e "   â€¢ Servicios instalados y configurados"
echo -e "   â€¢ ValidaciÃ³n de key desactivada"
echo -e "   â€¢ Usuario admin creado (admin/admin123)"
echo -e "   â€¢ Panel web disponible en puerto 81\033[0m"
echo ""
echo -e "\033[1;37mğŸŒ SERVICIOS ACTIVOS:\033[0m"
echo -e "   \033[1;33mSSH: 22 | Dropbear: 80,443 | Squid: 3128,8080"
echo -e "   Stunnel: 444,445 | Apache: 81\033[0m"
echo ""
echo -e "\033[1;37mğŸš€ COMANDOS RÃPIDOS:\033[0m"
echo -e "   \033[1;36madm\033[0m           - Abrir menÃº principal"
echo -e "   \033[1;36madm-tools\033[0m     - Herramientas del sistema"
echo -e "   \033[1;36msystemctl status ssh\033[0m - Ver estado SSH"
echo ""
echo -e "\033[1;37mğŸ”§ CONFIGURACIÃ“N:\033[0m"
echo -e "   \033[1;33mâ€¢ IP servidor: $(curl -s ifconfig.me 2>/dev/null || hostname -I)"
echo -e "   â€¢ Clave personal: $(cat /etc/cghkey)"
echo -e "   â€¢ Auto-inicio: Activado\033[0m"
echo ""
echo -e "\033[1;33mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "CrÃ©ditos: @ChumoGH / @joaquinH2 (base)"
echo "Modificado para uso personal"
echo -e "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m"
echo ""
echo -e "\033[1;32mâ³ Iniciando menÃº en 5 segundos...\033[0m"
echo -e "\033[1;33m(Presiona Ctrl+C para cancelar)\033[0m"
sleep 5

# Iniciar menÃº
cd /etc/adm-lite
./menu