#!/bin/bash

check_and_install_package() {
    local package=$1
    if ! dpkg -s "$package" &> /dev/null; then
        echo "Instalando $package..."
        sudo apt install -y "$package" &> /dev/null
        if [ $? -ne 0 ]; then
            echo "Error: no se pudo instalar $package."
            exit 1
        fi
    fi
}

required_packages=("curl" "wget" "dpkg")
for package in "${required_packages[@]}"; do
    check_and_install_package "$package"
done

check_and_install_lib() {
    local lib_path=$1
    local install_command=$2

    if [ ! -f "$lib_path" ]; then
        eval "$install_command" &> /dev/null
        if [ $? -ne 0 ]; then
            echo "Error: no se pudo instalar la librerÃ­a $lib_path."
            exit 1
        fi
    fi
}

check_and_install_lib "/usr/lib/x86_64-linux-gnu/libpthread.so.0" "true"
check_and_install_lib "/usr/lib/x86_64-linux-gnu/libdl.so.2" "true"
check_and_install_lib "/usr/lib/x86_64-linux-gnu/libc.so.6" "true"
check_and_install_lib "/usr/lib/x86_64-linux-gnu/libcrypto.so.1.1" "true"

ssl_install_command="wget -q http://archive.ubuntu.com/ubuntu/pool/main/o/openssl/libssl1.1_1.1.1f-1ubuntu2_amd64.deb && sudo dpkg -i libssl1.1_1.1.1f-1ubuntu2_amd64.deb &> /dev/null && rm libssl1.1_1.1.1f-1ubuntu2_amd64.deb"
check_and_install_lib "/usr/lib/x86_64-linux-gnu/libssl.so.1.1" "$ssl_install_command"

# ====================================================
# INSTALACIÃ“N DIRECTA SIN VALIDACIÃ“N DE KEY
# ====================================================

clear
echo -e "\033[1;36m"
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘        INSTALACIÃ“N MOD-V6                â•‘"
echo "â•‘         (MODO USO PERSONAL)              â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "\033[0m"
echo -e "\033[1;33mâš ï¸  ValidaciÃ³n de key deshabilitada para uso personal\033[0m"
echo ""
sleep 2

# Verificar si es root
if [ "$EUID" -ne 0 ]; then 
    echo -e "\033[1;31mâœ— Este script debe ejecutarse como root\033[0m"
    echo -e "Usa: \033[1;36msudo bash $0\033[0m"
    exit 1
fi

# Actualizar repositorios
echo -e "\033[1;32m[1/6] Actualizando repositorios...\033[0m"
apt-get update -y > /dev/null 2>&1

# Instalar paquetes adicionales necesarios
echo -e "\033[1;32m[2/6] Instalando paquetes adicionales...\033[0m"
extra_packages=("sudo" "nano" "net-tools" "lsof" "screen" "python3" "python3-pip" "git" "unzip" "bc")
for pkg in "${extra_packages[@]}"; do
    if ! dpkg -s "$pkg" &> /dev/null; then
        echo "  â†’ Instalando $pkg"
        apt-get install -y "$pkg" > /dev/null 2>&1
    fi
done

# Crear directorio principal
echo -e "\033[1;32m[3/6] Creando estructura de directorios...\033[0m"
mkdir -p /etc/adm-lite
cd /etc/adm-lite

# Descargar archivos principales
echo -e "\033[1;32m[4/6] Descargando archivos del sistema...\033[0m"

ARCHIVOS=("menu" "usercodes" "ferramentas" "cabecalho" "PPriv.py" "PPub.py" "PGet.py" "POpen.py" "fai2ban")

for archivo in "${ARCHIVOS[@]}"; do
    echo -ne "  â†’ Descargando $archivo "
    wget -q "https://raw.githubusercontent.com/joaquin1444/MOD-V6/main/script-v6/$archivo" -O "$archivo"
    if [ $? -eq 0 ]; then
        echo -e "\033[1;32mâœ“\033[0m"
        # Dar permisos de ejecuciÃ³n si es script
        if [[ "$archivo" == *.py ]] || [[ "$archivo" == "menu" ]] || [[ "$archivo" == "usercodes" ]] || [[ "$archivo" == "ferramentas" ]] || [[ "$archivo" == "fai2ban" ]]; then
            chmod +x "$archivo"
        fi
    else
        echo -e "\033[1;31mâœ—\033[0m"
    fi
done

# Crear clave personal automÃ¡tica
echo -e "\033[1;32m[5/6] Configurando sistema sin validaciÃ³n...\033[0m"
echo "LICENCIA-PERSONAL-$(hostname)-$(date +%Y%m%d-%H%M%S)" > /etc/cghkey
chmod 600 /etc/cghkey

# Modificar el menÃº para desactivar validaciÃ³n
if [ -f "menu" ]; then
    # Crear backup
    cp menu menu.backup
    
    # Reemplazar funciÃ³n chekKEY
    sed -i '/function chekKEY {/,/^}/c\
function chekKEY {\
    # FUNCIÃ“N MODIFICADA PARA USO PERSONAL\
    echo -e "\\\033[1;33m[INFO] ValidaciÃ³n desactivada para uso personal\\\033[0m" > /dev/null 2>&1\
    if [[ ! -e /etc/cghkey ]]; then\
        echo "LICENCIA-PERSONAL-$(hostname)-$(date +%Y%m%d)" > /etc/cghkey\
        chmod 600 /etc/cghkey\
    fi\
    return 0\
}' menu
    
    # Comentar llamada a chekKEY
    sed -i 's/chekKEY &> \/dev\/null 2>&1/#chekKEY &> \/dev\/null 2>&1  # Desactivado para uso personal/' menu
fi

# Crear accesos directos
echo '#!/bin/bash
cd /etc/adm-lite
./menu' > /usr/local/bin/adm
chmod +x /usr/local/bin/adm

echo '#!/bin/bash
cd /etc/adm-lite
./ferramentas' > /usr/local/bin/adm-tools
chmod +x /usr/local/bin/adm-tools

# ConfiguraciÃ³n final
echo -e "\033[1;32m[6/6] Aplicando configuraciones finales...\033[0m"

# Limpiar archivos de ban previos
rm -rf /etc/banned/ 2>/dev/null
rm -f /etc/folteto 2>/dev/null

# Instalar dependencias de Python si existen archivos .py
if ls *.py 1> /dev/null 2>&1; then
    pip3 install requests pprint > /dev/null 2>&1
fi

# ====================================================
# INSTALACIÃ“N COMPLETADA
# ====================================================

clear
echo -e "\033[1;36m"
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘        INSTALACIÃ“N COMPLETADA            â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "\033[0m"

echo -e "\033[1;32mâœ… Sistema instalado correctamente\033[0m"
echo ""
echo -e "\033[1;37mğŸ“ DIRECTORIO PRINCIPAL:\033[0m"
echo -e "   \033[1;36m/etc/adm-lite/\033[0m"
echo ""
echo -e "\033[1;37mğŸ”‘ CLAVE PERSONAL:\033[0m"
echo -e "   \033[1;33m$(cat /etc/cghkey 2>/dev/null)\033[0m"
echo ""
echo -e "\033[1;37mğŸš€ COMANDOS DISPONIBLES:\033[0m"
echo -e "   \033[1;36madm\033[0m           - MenÃº principal (acceso directo)"
echo -e "   \033[1;36madm-tools\033[0m     - Herramientas adicionales"
echo -e "   \033[1;36mcd /etc/adm-lite && ./menu\033[0m"
echo ""
echo -e "\033[1;37mğŸ“¦ ARCHIVOS INSTALADOS:\033[0m"
echo -e "   \033[1;33mâ€¢ menu, usercodes, ferramentas, cabecalho"
echo -e "   â€¢ PPriv.py, PPub.py, PGet.py, POpen.py"
echo -e "   â€¢ fai2ban\033[0m"
echo ""
echo -e "\033[1;33mâš ï¸  CONFIGURACIÃ“N ESPECIAL:\033[0m"
echo -e "   â€¢ ValidaciÃ³n de key \033[1;31mDESACTIVADA\033[1;33m"
echo -e "   â€¢ Modo uso personal activado"
echo -e "   â€¢ Clave personal generada automÃ¡ticamente"
echo ""
echo -e "\033[1;33mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "CrÃ©ditos originales: @ChumoGH / @joaquinH2"
echo "Modificado para uso personal"
echo -e "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m"
echo ""
read -p "Presiona Enter para probar el sistema..."
cd /etc/adm-lite && ./menu